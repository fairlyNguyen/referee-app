<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Referee Panel</title>
  <style>
  body { font-family: Arial, sans-serif; background: #f4f6f9; padding: 20px; }
  h2 { text-align: center; color: #333; }
  .card { max-width: 700px; margin: 20px auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
  .input-row { display: flex; margin-bottom: 12px; gap: 8px; }
  .input-row input { flex: 1; padding: 8px; border: 1px solid #ccc; border-radius: 8px; font-size: 14px; }
  .input-row button { padding: 8px 12px; border: none; background: #007bff; color: white; border-radius: 8px; cursor: pointer; }
  .court { position: relative; width: 100%; height: 240px; margin: 20px 0; background: #c8e6c9; border: 3px solid #2e7d32; border-radius: 10px; }
  .court-line { position: absolute; top: 50%; left: 0; width: 100%; height: 2px; background: #2e7d32; transform: translateY(-1px); }
  .court-vertical { position: absolute; top: 0; left: 50%; width: 2px; height: 100%; background: #2e7d32; }
  .player { position: absolute; width: 120px; padding: 8px; text-align: center; background: rgba(255,255,255,0.95); border-radius: 8px; font-weight: bold; font-size: 14px; cursor: pointer; user-select: none; }
  .home.top-left { top: 20px; left: 20px; }
  .home.bottom-left { bottom: 20px; left: 20px; }
  .away.top-right { top: 20px; right: 20px; }
  .away.bottom-right { bottom: 20px; right: 20px; }

  .first-server { border: 3px solid #ff9800; box-shadow: 0 0 10px rgba(255,152,0,0.7); }

  /* Score area */
  .score-container { display: flex; gap: 20px; margin: 20px 0; }
  .score-box { flex: 1; padding: 15px; border-radius: 10px; }
  .home { background: #e3f2fd; }
  .away { background: #fce4ec; }
  .score-header { font-weight: bold; margin-bottom: 10px; display: block; }
  .score-controls { display: flex; align-items: center; justify-content: center; gap: 10px; }
  .score-controls button { width: 36px; height: 36px; font-size: 20px; border: none; border-radius: 50%; cursor: pointer; background: #ddd; }
  .score-controls input { width: 60px; text-align: center; font-size: 18px; padding: 5px; border-radius: 6px; border: 1px solid #ccc; }

  .actions { margin-top: 20px; display: flex; gap: 8px; }
  .actions button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; }
  #updateBtn { background: #28a745; color: white; }
  #doneBtn { background: #dc3545; color: white; }

  @keyframes flash { 0% { box-shadow: 0 0 0 rgba(255,152,0,0.0); } 
                     50% { box-shadow: 0 0 18px rgba(255,152,0,0.9); } 
                     100% { box-shadow: 0 0 0 rgba(255,152,0,0.0); } }
  .flash { animation: flash 700ms ease; }
</style>
</head>
<body>
  <h2>üèì Referee Panel</h2>

  <div class="card">
    <div class="input-row">
      <input type="text" id="tourInput" placeholder="Enter Tournament ID" 
             value="75706b5a-55fa-4f7d-b8cd-7d7eb5e960bb">
    </div>
    <div class="input-row">
      <input type="text" id="matchInput" placeholder="Enter Match ID">
      <button id="findBtn">Find</button>
    </div>

    <div id="matchArea">
      <p><strong>Match:</strong> <span id="matchId">---</span></p>
      <div class="court">
        <div class="court-line"></div>
        <div class="court-vertical"></div>
        <div class="player home top-left" id="homePlayer1">Home --</div>
        <div class="player home bottom-left" id="homePlayer2">Home --</div>
        <div class="player away top-right" id="awayPlayer1">Away --</div>
        <div class="player away bottom-right" id="awayPlayer2">Away --</div>
      </div>

      <!-- Score area in 2 columns -->
      <div class="score-container">
        <div class="score-box home">
          <span class="score-header">Home: <span id="homeName">--</span></span>
          <div class="score-controls">
            <button data-team="home" data-delta="-1">-</button>
            <input type="number" id="homeScore" min="0" max="99" value="0">
            <button data-team="home" data-delta="1">+</button>
          </div>
        </div>

        <div class="score-box away">
          <span class="score-header">Away: <span id="awayName">--</span></span>
          <div class="score-controls">
            <button data-team="away" data-delta="-1">-</button>
            <input type="number" id="awayScore" min="0" max="99" value="0">
            <button data-team="away" data-delta="1">+</button>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="updateBtn">‚úÖ Update Score</button>
        <button id="doneBtn">üèÅ Set Done</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = { 
    apiKey: "AIzaSyD6tKItFtCJDYDxSLClLjJDqdR0scsU4kg",
    authDomain: "fir-demo-a1c99.firebaseapp.com",
    databaseURL: "https://fir-demo-a1c99.firebaseio.com",
    projectId: "fir-demo-a1c99",
    storageBucket: "fir-demo-a1c99.firebasestorage.app",
    messagingSenderId: "980490887183",
    appId: "1:980490887183:web:ef665624ab306006d7037a",
    measurementId: "G-TR0CCTRTGJ"
	};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentMatchId = null;
    let currentTourId = null;
	let currentServer = null;


    const playerIds = ["homePlayer1","homePlayer2","awayPlayer1","awayPlayer2"];

    const $ = id => document.getElementById(id);

    function getPlayerName(id) {
      return $(id)?.textContent.replace("üéæ","").trim() || "";
    }

    function highlightServer(playerId) {
      playerIds.forEach(id => {
        const el = $(id);
        el.classList.remove("first-server","flash");
        el.textContent = getPlayerName(id);
      });
      if (!playerId) return;
      const el = $(playerId);
      el.classList.add("first-server","flash");
      el.textContent = "üéæ " + getPlayerName(playerId);
      setTimeout(() => el.classList.remove("flash"), 800);
    }

    function swapPlayers(team) {
      const [p1, p2] = team === "home" ? ["homePlayer1","homePlayer2"] : ["awayPlayer1","awayPlayer2"];
      const t1 = $(p1).textContent;
      $(p1).textContent = $(p2).textContent;
      $(p2).textContent = t1;
    }

    function changeScore(team, delta) {
      const input = $(team + "Score");
      input.value = Math.max(0, (parseInt(input.value) || 0) + delta);
    }

    document.querySelectorAll(".score-controls button").forEach(btn => {
      btn.addEventListener("click", () => changeScore(btn.dataset.team, parseInt(btn.dataset.delta)));
    });

    async function loadMatch() {
      const matchId = $("matchInput").value.trim();
      const tourId = $("tourInput").value.trim();
      if (!matchId || !tourId) return alert("Enter IDs");

      const path = `tournaments/${tourId}/matches/${matchId}`;
      const snap = await get(ref(db, path));
      if (!snap.exists()) return alert("Match not found");

      const data = snap.val();
      currentMatchId = matchId;
      currentTourId = tourId;

      $("matchId").textContent = matchId;
      $("homeName").textContent = data.home || "--";
      $("awayName").textContent = data.away || "--";
      $("homeScore").value = data.homeScore ?? 0;
      $("awayScore").value = data.awayScore ?? 0;

      const [h1,h2] = (data.home||"Home1-Home2").split("-");
      const [a1,a2] = (data.away||"Away1-Away2").split("-");
      $("homePlayer1").textContent = h1;
      $("homePlayer2").textContent = h2;
      $("awayPlayer1").textContent = a1;
      $("awayPlayer2").textContent = a2;

      highlightServer(data.currentServer || "");
    }

  async function updateMatch() {
  if (!currentMatchId || !currentTourId) return alert("Load a match first!");

  const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;
  const snap = await get(ref(db, path));
  const data = snap.exists() ? snap.val() : {};

  const newHomeScore = parseInt($("homeScore").value) || 0;
  const newAwayScore = parseInt($("awayScore").value) || 0;

  // Determine which team scored
  let scoringTeam = null;
  if (newHomeScore > (data.homeScore || 0)) scoringTeam = "home";
  else if (newAwayScore > (data.awayScore || 0)) scoringTeam = "away";

  // Update local currentServer only if score changed
  if (scoringTeam) {
    const teamIds = scoringTeam === "home" ? ["homePlayer1","homePlayer2"] : ["awayPlayer1","awayPlayer2"];
    currentServer = currentServer === teamIds[0] ? teamIds[1] : teamIds[0];
	swapPlayers(scoringTeam);     
  }

  // Highlight UI
  highlightServer(currentServer);

  // Push only scores to Firebase, NOT currentServer
  await update(ref(db, path), {
    homeScore: newHomeScore,
    awayScore: newAwayScore,
    state: "ONGOING"
  });

  console.log("‚úÖ Match updated:", { newHomeScore, newAwayScore, currentServer });
}


    async function setDone() {
      if (!currentMatchId || !currentTourId) return;
      await update(ref(db, `tournaments/${currentTourId}/matches/${currentMatchId}`), { state: "FINISHED" });
      highlightServer("");
      alert("üèÅ Match Done");
    }

    $("findBtn").addEventListener("click", loadMatch);
    $("updateBtn").addEventListener("click", updateMatch);
    $("doneBtn").addEventListener("click", setDone);

    playerIds.forEach(id => {
      $(id).addEventListener("click", async () => {
		currentServer = id;
        highlightServer(id);
      });
    });

    console.log("‚úÖ JS Loaded");
  </script>
</body>
</html>
