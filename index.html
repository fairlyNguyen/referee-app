<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Referee Panel</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f6f9;
      padding: 20px;
    }
    h2 { text-align: center; color: #333; }
    .card {
      max-width: 500px;
      margin: 20px auto;
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    .input-row {
      display: flex;
      margin-bottom: 12px;
    }
    .input-row input, .input-row select {
      flex: 1;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 8px;
      font-size: 14px;
    }
    .input-row button {
      margin-left: 8px;
      padding: 8px 12px;
      border: none;
      background: #007bff;
      color: white;
      border-radius: 8px;
      cursor: pointer;
    }
    /* Court layout */
    .court {
      position: relative;
      width: 100%;
      height: 250px;
      margin: 20px 0;
      background: #c8e6c9;
      border: 3px solid #2e7d32;
      border-radius: 10px;
    }
    .court-line {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      background: #2e7d32;
    }
    .court-vertical {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 100%;
      background: #2e7d32;
    }
    .player {
      position: absolute;
      width: 100px;
      padding: 6px;
      text-align: center;
      background: rgba(255,255,255,0.9);
      border-radius: 8px;
      font-weight: bold;
      font-size: 14px;
    }
    /* Home team positions */
    .home.top-left { top: 20px; left: 20px; }
    .home.bottom-left { bottom: 20px; left: 20px; }
    /* Away team positions */
    .away.top-right { top: 20px; right: 20px; }
    .away.bottom-right { bottom: 20px; right: 20px; }

    /* Highlight server */
    .first-server {
      border: 3px solid #ff9800;
      box-shadow: 0 0 10px rgba(255, 152, 0, 0.7);
    }
    .player .serve-icon {
      margin-left: 6px;
      font-size: 16px;
      color: #ff9800;
    }

    /* Score controls */
    .score-box {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin: 10px 0;
      padding: 10px;
      border-radius: 8px;
    }
    .home { background: #e3f2fd; }
    .away { background: #fce4ec; }
    .score-controls {
      display: flex;
      align-items: center;
    }
    .score-controls button {
      width: 32px; height: 32px;
      font-size: 18px;
      border: none;
      border-radius: 50%;
      margin: 0 5px;
      cursor: pointer;
      background: #ddd;
    }
    .score-controls input {
      width: 50px;
      text-align: center;
      font-size: 16px;
      padding: 5px;
    }
    .actions {
      margin-top: 20px;
      display: flex;
      justify-content: space-between;
    }
    .actions button {
      flex: 1;
      margin: 0 5px;
      padding: 10px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }
    #updateBtn { background: #28a745; color: white; }
    #doneBtn { background: #dc3545; color: white; }
  </style>
</head>
<body>
  <h2>üèì Referee Panel</h2>

  <div class="card">
    <!-- Tournament ID -->
    <div class="input-row">
      <input type="text" id="tourInput" placeholder="Enter Tournament ID">
    </div>

    <!-- Match ID -->
    <div class="input-row">
      <input type="text" id="matchInput" placeholder="Enter Match ID">
      <button id="findBtn">Find</button>
    </div>

    <!-- Match Info -->
    <div id="matchArea">
      <p><strong>Match:</strong> <span id="matchId">---</span></p>

      <!-- Court -->
      <div class="court">
        <div class="court-line"></div>
        <div class="court-vertical"></div>
        <div class="player home top-left" id="homePlayer1">Home --</div>
        <div class="player home bottom-left" id="homePlayer2">Home --</div>
        <div class="player away top-right" id="awayPlayer1">Away --</div>
        <div class="player away bottom-right" id="awayPlayer2">Away --</div>
      </div>

      <!-- First Server -->
      <div class="input-row">
        <select id="firstServer">
          <option value="">-- Select First Server --</option>
          <option value="homePlayer1">Home Player 1</option>
          <option value="homePlayer2">Home Player 2</option>
          <option value="awayPlayer1">Away Player 1</option>
          <option value="awayPlayer2">Away Player 2</option>
        </select>
      </div>

      <div class="score-box home">
        <strong>Home:</strong> <span id="homeName">--</span>
        <div class="score-controls">
          <button onclick="changeScore('home', -1)">-</button>
          <input type="number" id="homeScore" min="0" max="11" value="0">
          <button onclick="changeScore('home', 1)">+</button>
        </div>
      </div>

      <div class="score-box away">
        <strong>Away:</strong> <span id="awayName">--</span>
        <div class="score-controls">
          <button onclick="changeScore('away', -1)">-</button>
          <input type="number" id="awayScore" min="0" max="11" value="0">
          <button onclick="changeScore('away', 1)">+</button>
        </div>
      </div>

      <div class="actions">
        <button id="updateBtn">‚úÖ Update Score</button>
        <button id="doneBtn">üèÅ Set Done</button>
      </div>
    </div>
  </div>

  <script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  console.log("‚úÖ JS Loaded");

  // ‚ö†Ô∏è replace with your real Firebase config
    const firebaseConfig = {
    apiKey: "AIzaSyD6tKItFtCJDYDxSLClLjJDqdR0scsU4kg",
    authDomain: "fir-demo-a1c99.firebaseapp.com",
    databaseURL: "https://fir-demo-a1c99.firebaseio.com",
    projectId: "fir-demo-a1c99",
    storageBucket: "fir-demo-a1c99.firebasestorage.app",
    messagingSenderId: "980490887183",
    appId: "1:980490887183:web:ef665624ab306006d7037a",
    measurementId: "G-TR0CCTRTGJ"
  };

  let app, db;
  try {
    app = initializeApp(firebaseConfig);
    db = getDatabase(app);
    console.log("‚úÖ Firebase initialized");
  } catch (e) {
    console.error("‚ùå Firebase init error:", e);
    alert("Firebase config error! Check console.");
  }

  let currentMatchId = null;
  let currentTourId = null;

  // -------- Helpers ----------
  window.changeScore = function (team, delta) {
    const input = document.getElementById(team + "Score");
    let val = parseInt(input.value || "0", 10);
    val = Math.max(0, val + delta);
    input.value = val;
  };

  function highlightCurrentServer(playerId) {
    const allPlayers = ["homePlayer1","homePlayer2","awayPlayer1","awayPlayer2"];
    allPlayers.forEach(id => {
      const el = document.getElementById(id);
      if (!el) return;
      el.classList.remove("first-server");
      const oldIcon = el.querySelector(".serve-icon");
      if (oldIcon) oldIcon.remove();
      if (id === playerId) {
        el.classList.add("first-server");
        const icon = document.createElement("span");
        icon.className = "serve-icon";
        icon.textContent = "üéæ";
        el.appendChild(icon);
      }
    });
  }

  function getNextServer(current) {
    switch (current) {
      case "homePlayer1": return "homePlayer2";
      case "homePlayer2": return "awayPlayer1";
      case "awayPlayer1": return "awayPlayer2";
      case "awayPlayer2": return "homePlayer1";
      default: return "homePlayer1";
    }
  }

  function swapSides() {
    const homeP1 = document.getElementById("homePlayer1").textContent;
    const homeP2 = document.getElementById("homePlayer2").textContent;
    const awayP1 = document.getElementById("awayPlayer1").textContent;
    const awayP2 = document.getElementById("awayPlayer2").textContent;

    document.getElementById("homePlayer1").textContent = awayP1;
    document.getElementById("homePlayer2").textContent = awayP2;
    document.getElementById("awayPlayer1").textContent = homeP1;
    document.getElementById("awayPlayer2").textContent = homeP2;

    return { home: `${awayP1}-${awayP2}`, away: `${homeP1}-${homeP2}` };
  }

  // -------- FIND BUTTON ----------
  document.getElementById("findBtn")?.addEventListener("click", async () => {
    console.log("üîç Find button clicked");
    try {
      const matchId = document.getElementById("matchInput").value.trim();
      const tourId = document.getElementById("tourInput").value.trim();

      if (!tourId) return alert("Enter a Tournament ID!");
      if (!matchId) return alert("Enter a Match ID!");

      const path = `tournaments/${tourId}/matches/${matchId}`;
      console.log("üìÇ Fetching path:", path);

      const matchRef = ref(db, path);
      const snapshot = await get(matchRef);

      if (snapshot.exists()) {
        const data = snapshot.val();
        console.log("‚úÖ Data found:", data);

        currentMatchId = matchId;
        currentTourId = tourId;

        document.getElementById("matchId").textContent = matchId;
        document.getElementById("homeName").textContent = data.home || "--";
        document.getElementById("awayName").textContent = data.away || "--";
        document.getElementById("homeScore").value = data.homeScore ?? 0;
        document.getElementById("awayScore").value = data.awayScore ?? 0;

        const homePlayers = (data.home || "Home1-Home2").split("-");
        const awayPlayers = (data.away || "Away1-Away2").split("-");

        document.getElementById("homePlayer1").textContent = homePlayers[0] || "Home --";
        document.getElementById("homePlayer2").textContent = homePlayers[1] || "Home --";
        document.getElementById("awayPlayer1").textContent = awayPlayers[0] || "Away --";
        document.getElementById("awayPlayer2").textContent = awayPlayers[1] || "Away --";

        document.getElementById("firstServer").value = data.firstServer || "";
        highlightCurrentServer(data.currentServer || data.firstServer || "");
      } else {
        console.warn("‚ö†Ô∏è Match not found at:", path);
        alert("Match not found!");
      }
    } catch (err) {
      console.error("‚ùå Find error:", err);
      alert("Error: " + err.message);
    }
  });

  // -------- UPDATE SCORE BUTTON ----------
  document.getElementById("updateBtn")?.addEventListener("click", async () => {
    console.log("üíæ Update button clicked");
    if (!currentMatchId || !currentTourId) {
      alert("‚ö†Ô∏è Load a match first using Find!");
      return;
    }

    try {
      const homeScore = parseInt(document.getElementById("homeScore").value, 10) || 0;
      const awayScore = parseInt(document.getElementById("awayScore").value, 10) || 0;
      const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;

      let currentServer = document.getElementById("firstServer").value;
      const snap = await get(ref(db, path));
      if (snap.exists()) {
        const data = snap.val();
        currentServer = getNextServer(data.currentServer || data.firstServer || currentServer);
      }

      highlightCurrentServer(currentServer);

      await update(ref(db, path), {
        homeScore, awayScore, state: "ONGOING",
        firstServer: document.getElementById("firstServer").value,
        currentServer
      });
    } catch (err) {
      console.error("‚ùå Update error:", err);
      alert("Update failed: " + err.message);
    }
  });

  // -------- SET DONE BUTTON ----------
  document.getElementById("doneBtn")?.addEventListener("click", async () => {
    console.log("üèÅ Done button clicked");
    if (!currentMatchId || !currentTourId) {
      alert("‚ö†Ô∏è Load a match first using Find!");
      return;
    }

    try {
      const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;
      const swapped = swapSides();

      const firstServer = document.getElementById("firstServer").value;
      const currentServer = document.querySelector(".first-server")?.id || "";

      // reset scores for new set
      document.getElementById("homeScore").value = 0;
      document.getElementById("awayScore").value = 0;

      await update(ref(db, path), {
        state: "FINISHED",
        firstServer,
        currentServer,
        home: swapped.home,
        away: swapped.away,
        homeScore: 0,
        awayScore: 0
      });

      alert("üèÅ Match marked as Done & sides swapped!");
    } catch (err) {
      console.error("‚ùå Done error:", err);
      alert("Failed to mark done: " + err.message);
    }
  });

  // -------- Dropdown change ----------
  document.getElementById("firstServer")?.addEventListener("change", (e) => {
    highlightCurrentServer(e.target.value);
  });
  </script>
</body>
</html>
