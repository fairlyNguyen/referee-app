<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>STM Referee</title>
 <style>
    body {
      font-family: 'Arial', sans-serif;
      background: #f4f6f9;
      padding: 20px;
    }
    h2 {
      text-align: center;
      color: #333;
      margin-bottom: 20px;
    }

    .card {
      max-width: 800px;
      margin: 0 auto 30px auto;
      background: #fff;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.08);
    }

    .input-row {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    .input-row input {
      flex: 1;
      padding: 10px 12px;
      font-size: 14px;
      border-radius: 8px;
      border: 1px solid #ccc;
    }
    .input-row button {
      padding: 10px 16px;
      background-color: #007bff;
      color: #fff;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.2s;
    }
    .input-row button:hover {
      background-color: #0056b3;
    }

    .court {
      position: relative;
      width: 100%;
      height: 260px;
      margin: 20px 0;
      background: #dcedc8;
      border: 3px solid #2e7d32;
      border-radius: 12px;
    }
    .court-line {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 2px;
      background: #2e7d32;
      transform: translateY(-1px);
    }
    .court-vertical {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 100%;
      background: #2e7d32;
    }
    .player {
      position: absolute;
      width: 130px;
      padding: 8px;
      text-align: center;
      background: rgba(255,255,255,0.95);
      border-radius: 10px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s;
    }
    .player:hover {
      transform: scale(1.05);
    }
    .home.top-left { top: 20px; left: 20px; }
    .home.bottom-left { bottom: 20px; left: 20px; }
    .away.top-right { top: 20px; right: 20px; }
    .away.bottom-right { bottom: 20px; right: 20px; }

    .first-server {
      border: 3px solid #ff9800;
      box-shadow: 0 0 12px rgba(255,152,0,0.7);
    }

    .score-container {
      display: flex;
      justify-content: space-between;
      gap: 20px;
      margin: 20px 0;
    }
    .score-box {
      flex: 1;
      padding: 18px;
      border-radius: 12px;
      background: #f0f0f0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .score-box.home { background: #e3f2fd; }
    .score-box.away { background: #fce4ec; }
    .score-header { font-weight: bold; margin-bottom: 10px; font-size: 16px; }
    .score-controls {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .score-controls button {
      width: 40px;
      height: 40px;
      font-size: 20px;
      border-radius: 50%;
      border: none;
      background: #ddd;
      cursor: pointer;
      transition: background 0.2s;
    }
    .score-controls button:hover {
      background: #bbb;
    }
    .score-controls input {
      width: 70px;
      text-align: center;
      font-size: 18px;
      padding: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
    }

    .actions {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }
    .actions button {
      flex: 1;
      padding: 12px;
      font-weight: bold;
      font-size: 15px;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }
    #changeSidesBtn { background: #28a745; color: #fff; }
    #changeSidesBtn:hover { background: #1e7e34; }
    #doneBtn { background: #dc3545; color: #fff; }
    #doneBtn:hover { background: #b02a37; }

    .swap-buttons {
      display: flex;
      gap: 10px;
      justify-content: center;
      margin-top: 15px;
    }
    .swap-buttons button {
      padding: 10px 14px;
      border-radius: 10px;
      font-weight: bold;
      border: none;
      cursor: pointer;
      background: #ff9800;
      color: #fff;
      transition: background 0.2s;
    }
    .swap-buttons button:hover { background: #e67e00; }

  </style>
</head>
<body>
  <h2>üèì Referee Panel</h2>

  <div class="card">
    <div class="input-row">
      <input type="text" id="tourInput" placeholder="Enter Tournament ID" value="019f62b7-5eb6-4092-9279-df9ddb48449d">
    </div>
    <div class="input-row">
      <input type="text" id="matchInput" placeholder="Enter Match ID">
      <button id="findBtn">Find</button>
    </div>

    <div id="matchArea">
      <p><strong>Match:</strong> <span id="matchId">---</span></p>
      <div class="court">
        <div class="court-line"></div>
        <div class="court-vertical"></div>
        <div class="player home top-left" id="homePlayer1">Home --</div>
        <div class="player home bottom-left" id="homePlayer2">Home --</div>
        <div class="player away top-right" id="awayPlayer1">Away --</div>
        <div class="player away bottom-right" id="awayPlayer2">Away --</div>
      </div>

      <div class="swap-buttons">
        <button id="swapHomeBtn">üîÑ Swap Home Positions</button>
        <button id="swapAwayBtn">üîÑ Swap Away Positions</button>
      </div>

      <div class="score-container">
        <div class="score-box home">
          <span class="score-header">Home: <span id="homeName">--</span></span>
          <div class="score-controls">
            <button data-team="home" data-delta="-1">-</button>
            <input type="number" id="homeScore" min="0" max="99" value="0">
            <button data-team="home" data-delta="1">+</button>
          </div>
        </div>
        <div class="score-box away">
          <span class="score-header">Away: <span id="awayName">--</span></span>
          <div class="score-controls">
            <button data-team="away" data-delta="-1">-</button>
            <input type="number" id="awayScore" min="0" max="99" value="0">
            <button data-team="away" data-delta="1">+</button>
          </div>
        </div>
      </div>

      <div class="actions">
        <button id="changeSidesBtn">üîÑ Change Sides</button>
        <button id="doneBtn">üèÅ Set Done</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = { 
		apiKey: "AIzaSyD6tKItFtCJDYDxSLClLjJDqdR0scsU4kg",
		authDomain: "fir-demo-a1c99.firebaseapp.com",
		databaseURL: "https://fir-demo-a1c99.firebaseio.com",
		projectId: "fir-demo-a1c99",
		storageBucket: "fir-demo-a1c99.firebasestorage.app",
		messagingSenderId: "980490887183",
		appId: "1:980490887183:web:ef665624ab306006d7037a",
		measurementId: "G-TR0CCTRTGJ"
	};
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentMatchId = null;
    let currentTourId = null;
	let currentServer = null;


    const playerIds = ["homePlayer1","homePlayer2","awayPlayer1","awayPlayer2"];

    const $ = id => document.getElementById(id);

    function getPlayerName(id) {
      return $(id)?.textContent.replace("üéæ","").trim() || "";
    }

    function highlightServer(playerId) {
      playerIds.forEach(id => {
        const el = $(id);
        el.classList.remove("first-server","flash");
        el.textContent = getPlayerName(id);
      });
      if (!playerId) return;
      const el = $(playerId);
      el.classList.add("first-server","flash");
      el.textContent = "üéæ " + getPlayerName(playerId);
      setTimeout(() => el.classList.remove("flash"), 800);
    }

    function swapPlayers(team) {
      const [p1, p2] = team === "home" ? ["homePlayer1","homePlayer2"] : ["awayPlayer1","awayPlayer2"];
      const t1 = $(p1).textContent;
      $(p1).textContent = $(p2).textContent;
      $(p2).textContent = t1;
    }

    function changeScore(team, delta) {
      const input = $(team + "Score");
      input.value = Math.max(0, (parseInt(input.value) || 0) + delta);
    }

    document.querySelectorAll(".score-controls button").forEach(btn => {
      btn.addEventListener("click", () => changeScore(btn.dataset.team, parseInt(btn.dataset.delta)));
    });

    async function loadMatch() {
  const matchId = $("matchInput").value.trim();
  const tourId = $("tourInput").value.trim();
  if (!matchId || !tourId) return alert("Enter Tournament and Match IDs");

  const path = `tournaments/${tourId}/matches/${matchId}`;
  const snap = await get(ref(db, path));
  if (!snap.exists()) return alert("Match not found");

  const data = snap.val();
  currentMatchId = matchId;
  currentTourId = tourId;

  // --- Parse players from data ---
  // Expecting format "Player1-Player2"
  homePlayers = (data.home || "Home1-Home2").split("-").map(p => p.trim());
  awayPlayers = (data.away || "Away1-Away2").split("-").map(p => p.trim());

  // --- Update player elements on court ---
  $("homePlayer1").textContent = homePlayers[0];
  $("homePlayer2").textContent = homePlayers[1];
  $("awayPlayer1").textContent = awayPlayers[0];
  $("awayPlayer2").textContent = awayPlayers[1];

  // --- Update score fields ---
  $("homeScore").value = data.homeScore ?? 0;
  $("awayScore").value = data.awayScore ?? 0;

  // --- Update names display ---
  $("homeName").textContent = homePlayers.join(" - ");
  $("awayName").textContent = awayPlayers.join(" - ");

  // --- Highlight current server ---
  currentServer = data.currentServer || null;
  highlightServer(currentServer);

  console.log("‚úÖ Match loaded successfully!", { homePlayers, awayPlayers, currentServer });
}


  async function updateMatch() {
  if (!currentMatchId || !currentTourId) return alert("Load a match first!");

  const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;
  const snap = await get(ref(db, path));
  const data = snap.exists() ? snap.val() : {};
  
  const matchState = data.state
  if(matchState == "FINISHED") {
	  return alert("Match already finished. Cannot update.");
  }

  const newHomeScore = parseInt($("homeScore").value) || 0;
  const newAwayScore = parseInt($("awayScore").value) || 0;

  // Determine which team scored
  let scoringTeam = null;
  if (newHomeScore > (data.homeScore || 0)) scoringTeam = "home";
  else if (newAwayScore > (data.awayScore || 0)) scoringTeam = "away";

  // Update local currentServer only if score changed
  if (scoringTeam) {
    const teamIds = scoringTeam === "home" ? ["homePlayer1","homePlayer2"] : ["awayPlayer1","awayPlayer2"];
    currentServer = currentServer === teamIds[0] ? teamIds[1] : teamIds[0];
	swapPlayers(scoringTeam);     
  }

  // Highlight UI
  highlightServer(currentServer);

  // Push only scores to Firebase, NOT currentServer
  await update(ref(db, path), {
    homeScore: newHomeScore,
    awayScore: newAwayScore,
    state: "ONGOING",
	isChangeSides: false
  });

  console.log("‚úÖ Match updated:", { newHomeScore, newAwayScore, currentServer });
}

// Keep track of players globally
let homePlayers = [];
let awayPlayers = [];

async function changeSides() {
   if (!currentMatchId || !currentTourId) {
    return alert("Please load a match first before changing sides.");
  }
  
  const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;
  const snap = await get(ref(db, path));
  const data = snap.exists() ? snap.val() : {};
  
  const matchState = data.state
  if(matchState == "FINISHED") {
	  return alert("Match already finished. Cannot update.");
  }
  

  console.log("üîÑ Changing sides...");

  // 1. Swap players in memory
  [homePlayers, awayPlayers] = [awayPlayers, homePlayers];

  // 2. Swap scores from UI
  const homeScoreEl = $("homeScore");
  const awayScoreEl = $("awayScore");
  const newHomeScore = parseInt(awayScoreEl.value) || 0;
  const newAwayScore = parseInt(homeScoreEl.value) || 0;

  // 3. Swap server
  let newServerId = null;
  if (currentServer) {
    if (currentServer.startsWith("home")) {
      const index = currentServer === "homePlayer1" ? 0 : 1;
      newServerId = "awayPlayer" + (index + 1);
    } else {
      const index = currentServer === "awayPlayer1" ? 0 : 1;
      newServerId = "homePlayer" + (index + 1);
    }
  }

  // 4. Prepare data for Firebase
  const updateData = {
    home: homePlayers.join("-"),
    away: awayPlayers.join("-"),
    homeScore: newHomeScore,
    awayScore: newAwayScore,
    currentServer: newServerId,
	isChangeSides: true
  };

  await update(ref(db, path), updateData);

  // 5. Update UI
  $("homePlayer1").textContent = homePlayers[0];
  $("homePlayer2").textContent = homePlayers[1];
  $("awayPlayer1").textContent = awayPlayers[0];
  $("awayPlayer2").textContent = awayPlayers[1];

  $("homeName").textContent = homePlayers.join(" - ");
  $("awayName").textContent = awayPlayers.join(" - ");

  $("homeScore").value = newHomeScore;
  $("awayScore").value = newAwayScore;

  // 6. Update server state
  currentServer = newServerId;
  highlightServer(currentServer);

  console.log("‚úÖ Sides changed and data successfully saved to Firebase!");
}

async function swapTeamPositions(team) {
  const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;
  const snap = await get(ref(db, path));
  const data = snap.exists() ? snap.val() : {};
  
  const matchState = data.state
  if(matchState == "FINISHED") {
	  return alert("Match already finished. Cannot update.");
  }
  
  if (team === "home") {
    const p1 = $("homePlayer1");
    const p2 = $("homePlayer2");
    [p1.textContent, p2.textContent] = [p2.textContent, p1.textContent];
    [homePlayers[0], homePlayers[1]] = [homePlayers[1], homePlayers[0]];
  } else if (team === "away") {
    const p1 = $("awayPlayer1");
    const p2 = $("awayPlayer2");
    [p1.textContent, p2.textContent] = [p2.textContent, p1.textContent];
    [awayPlayers[0], awayPlayers[1]] = [awayPlayers[1], awayPlayers[0]];
  }
  console.log(`‚úÖ ${team} team positions swapped`);
}


const buttons = document.querySelectorAll('button[data-delta]');
buttons.forEach(button => {
  button.addEventListener('click', () => {
    updateMatch();
  });
});


async function setDone() {
      if (!currentMatchId || !currentTourId) return;
	  
	 const path = `tournaments/${currentTourId}/matches/${currentMatchId}`;
	const snap = await get(ref(db, path));
	const data = snap.exists() ? snap.val() : {};
  
	const matchState = data.state
	if(matchState == "FINISHED") {
	  return alert("Match already finished. Cannot update.");
	}
  
      await update(ref(db, path), { 
	  isChangeSides: false,
	  state: "FINISHED" });
      highlightServer("");
	  
      alert("üèÅ Match Done");
    }

    $("findBtn").addEventListener("click", loadMatch);
    $("changeSidesBtn").addEventListener("click", changeSides);
    $("doneBtn").addEventListener("click", setDone);
	$("swapHomeBtn").addEventListener("click", () => swapTeamPositions("home"));
	$("swapAwayBtn").addEventListener("click", () => swapTeamPositions("away"));

    playerIds.forEach(id => {
      $(id).addEventListener("click", async () => {
		currentServer = id;
        highlightServer(id);
      });
    });

    console.log("‚úÖ JS Loaded");
  </script>
</body>
</html>
